From ce67cb94f4ac2df31c77822a4f7b87fad0b3ebfa Mon Sep 17 00:00:00 2001
From: Chris Burr <christopher.burr@cern.ch>
Date: Mon, 27 Jan 2020 08:12:25 +0100
Subject: [PATCH] Allow tests to be ran with minimal dependencies

---
 tests/test_compression.py |  8 +++++---
 tests/test_http.py        |  2 +-
 tests/test_issues.py      |  1 +
 tests/test_tree.py        | 10 ++++++----
 tests/test_versions.py    |  6 ++++--
 5 files changed, 17 insertions(+), 10 deletions(-)

diff --git a/tests/test_compression.py b/tests/test_compression.py
index fbf1e92..2964b3d 100644
--- a/tests/test_compression.py
+++ b/tests/test_compression.py
@@ -2,15 +2,17 @@
 
 # BSD 3-Clause License; see https://github.com/scikit-hep/uproot/blob/master/LICENSE
 
+import pytest
 try:
     import lzma
 except ImportError:
-    from backports import lzma
-import lz4
-import zstandard
+    lzma = pytest.importorskip('backports.lzma')
+lz4 = pytest.importorskip('lz4')
+zstandard = pytest.importorskip('zstandard')
 
 import uproot
 
+
 class Test(object):
     def test_compression_identity(self):
         assert uproot.open("tests/samples/Zmumu-zlib.root").compression.algoname == "zlib"
diff --git a/tests/test_http.py b/tests/test_http.py
index e52dd02..f725569 100644
--- a/tests/test_http.py
+++ b/tests/test_http.py
@@ -4,7 +4,7 @@
 
 import pytest
 import mock
-from requests.exceptions import HTTPError
+HTTPError = pytest.importorskip('requests.exceptions').HTTPError
 
 import uproot
 
diff --git a/tests/test_issues.py b/tests/test_issues.py
index 7d2b42e..0e1373e 100644
--- a/tests/test_issues.py
+++ b/tests/test_issues.py
@@ -248,6 +248,7 @@ class Test(object):
         assert t.array("V0s.fEtaPos")[-3].tolist() == [-0.390625, 0.046875]
 
     def test_issue213(self):
+        pytest.importorskip("xxhash")
         t = uproot.open("tests/samples/issue213.root")["T"]
         assert t["fMCHits.fPosition"].array().x.tolist() == [
             [], [], [], [], [], [], [], [42.17024612426758, 50.63192367553711],
diff --git a/tests/test_tree.py b/tests/test_tree.py
index cf4fdfc..b154955 100644
--- a/tests/test_tree.py
+++ b/tests/test_tree.py
@@ -595,12 +595,13 @@ class Test(object):
     @pytest.mark.parametrize("use_http", [False, True])
     def test_hist_in_tree(self, use_http):
         if use_http:
+            pytest.importorskip("requests")
+            tree = uproot.open("http://scikit-hep.org/uproot/examples/Event.root")["T"]
+        else:
             path = os.path.join("tests", "samples", "Event.root")
             if not os.path.exists(path):
                 raise pytest.skip()
             tree = uproot.open(path)["T"]
-        else:
-            tree = uproot.open("http://scikit-hep.org/uproot/examples/Event.root")["T"]
         check = [0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0,
                  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 1.0, 1.0,
                  1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
@@ -625,12 +626,13 @@ class Test(object):
             b'fTriggerBits.TObject'
         ]
         if use_http:
+            pytest.importorskip("requests")
+            tree = uproot.open("http://scikit-hep.org/uproot/examples/Event.root")["T"]
+        else:
             path = os.path.join("tests", "samples", "Event.root")
             if not os.path.exists(path):
                 raise pytest.skip()
             tree = uproot.open(path)["T"]
-        else:
-            tree = uproot.open("http://scikit-hep.org/uproot/examples/Event.root")["T"]
         branches_without_interp = [b.name for b in tree.allvalues() if b.interpretation is None]
         assert branches_without_interp == known_branches_without_interp
         assert tree.array("fTracks.fTArray[3]", entrystop=10)[5][10].tolist()  == [11.03951644897461, 19.40645980834961, 34.54059982299805]
diff --git a/tests/test_versions.py b/tests/test_versions.py
index e31526f..eb77237 100644
--- a/tests/test_versions.py
+++ b/tests/test_versions.py
@@ -2,14 +2,16 @@
 
 # BSD 3-Clause License; see https://github.com/scikit-hep/uproot/blob/master/LICENSE
 
+import pytest
 try:
     import lzma
 except ImportError:
-    from backports import lzma
-import lz4
+    lzma = pytest.importorskip('backports.lzma')
+lz4 = pytest.importorskip('lz4')
 
 import uproot
 
+
 class Test(object):
     sample = {
         b"n": [0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4],
-- 
2.21.0

